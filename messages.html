<!DOCTYPE html>
<html>
<head>
    <title>–°–æ–æ–±—â–µ–Ω–∏—è - MySocialNet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üê¨ MySocialNet</h1>
        <nav>
            <a href="index.html" class="nav-btn">üè† –õ–µ–Ω—Ç–∞</a>
            <a href="profile.html" class="nav-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="friends.html" class="nav-btn">üë• –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-btn active">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <span id="userWelcome"></span>
            <button onclick="logout()" class="btn logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </nav>
    </header>

    <div class="container">
        <div class="messages-container">
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chats-sidebar">
                <div class="chats-header">
                    <h3>üí¨ –ß–∞—Ç—ã</h3>
                    <button onclick="startNewChat()" class="btn btn-small">‚ûï –ù–æ–≤—ã–π —á–∞—Ç</button>
                </div>
                <div class="chats-list" id="chatsList">
                    <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="messages-area">
                <div class="chat-header" id="chatHeader">
                    <div class="select-chat">
                        <h3>üëÜ –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–∑—å—è–º–∏!</p>
                    </div>
                </div>

                <div class="messages-list" id="messagesList">
                    <div class="welcome-message">
                        <h3>üí¨ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä!</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                        <div class="features-list">
                            <div class="feature">‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                            <div class="feature">‚úÖ –û–±–º–µ–Ω —ç–º–æ–¥–∑–∏</div>
                            <div class="feature">‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        </div>
                    </div>
                </div>

                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="message-input">
                        <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleMessageKeyPress(event)">
                        <div class="emoji-buttons">
                            <button onclick="addMessageEmoji('üòä')" class="emoji-btn">üòä</button>
                            <button onclick="addMessageEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
                            <button onclick="addMessageEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                            <button onclick="addMessageEmoji('üëç')" class="emoji-btn">üëç</button>
                        </div>
                        <button onclick="sendMessage()" class="btn send-btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewChatModal()">&times;</span>
            <h3>üí¨ –ù–æ–≤—ã–π —á–∞—Ç</h3>
            <div class="friends-for-chat" id="friendsForChat">
                <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –¥–ª—è —á–∞—Ç–∞ -->
            </div>
        </div>
    </div>

    <script type="module">
        import { friendsAPI } from './supabase.js'

        let currentUser = null
        let currentChat = null

        // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ Supabase)
        let messages = JSON.parse(localStorage.getItem('messages') || '[]')

        function checkAuth() {
            currentUser = localStorage.getItem('currentUser')
            if (!currentUser) {
                window.location.href = 'login.html'
                return
            }
            document.getElementById('userWelcome').textContent = currentUser
            loadChats()
        }

        async function loadChats() {
            const chatsList = document.getElementById('chatsList')
            chatsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>'
            
            try {
                const userFriends = await friendsAPI.getFriends(currentUser)
                
                chatsList.innerHTML = ''
                
                if (userFriends.length === 0) {
                    chatsList.innerHTML = '<div class="no-chats">üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>'
                    return
                }
                
                userFriends.forEach(friendship => {
                    const friendUsername = friendship.user1 === currentUser ? friendship.user2 : friendship.user1
                    const chatMessages = messages.filter(m => 
                        (m.sender === currentUser && m.receiver === friendUsername) ||
                        (m.sender === friendUsername && m.receiver === currentUser)
                    )
                    
                    const lastMessage = chatMessages[chatMessages.length - 1]
                    
                    const chatElement = document.createElement('div')
                    chatElement.className = `chat-item ${currentChat === friendUsername ? 'active' : ''}`
                    chatElement.onclick = () => openChat(friendUsername)
                    chatElement.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${friendUsername}&background=667eea&color=fff" class="avatar">
                        <div class="chat-info">
                            <div class="chat-header">
                                <strong>${friendUsername}</strong>
                            </div>
                            <div class="last-message">
                                ${lastMessage ? (lastMessage.sender === currentUser ? '–í—ã: ' : '') + lastMessage.content : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
                            </div>
                        </div>
                    `
                    chatsList.appendChild(chatElement)
                })
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error)
                chatsList.innerHTML = '<div class="no-chats">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</div>'
            }
        }

        function openChat(friendUsername) {
            currentChat = friendUsername
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'))
            event.currentTarget.classList.add('active')
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            document.getElementById('chatHeader').innerHTML = `
                <div class="active-chat-header">
                    <img src="https://ui-avatars.com/api/?name=${friendUsername}&background=667eea&color=fff" class="avatar">
                    <div class="chat-user-info">
                        <strong>${friendUsername}</strong>
                        <span class="user-status">üü¢ –í —Å–µ—Ç–∏</span>
                    </div>
                    <button onclick="clearChat('${friendUsername}')" class="btn btn-small btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                </div>
            `
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInputContainer').style.display = 'block'
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages(friendUsername)
        }

        function loadMessages(friendUsername) {
            const messagesList = document.getElementById('messagesList')
            const chatMessages = messages.filter(m => 
                (m.sender === currentUser && m.receiver === friendUsername) ||
                (m.sender === friendUsername && m.receiver === currentUser)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
            
            messagesList.innerHTML = ''
            
            if (chatMessages.length === 0) {
                messagesList.innerHTML = `
                    <div class="no-messages">
                        <h4>üí¨ –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</h4>
                        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${friendUsername}</p>
                    </div>
                `
                return
            }
            
            chatMessages.forEach(message => {
                const isMyMessage = message.sender === currentUser
                const messageElement = document.createElement('div')
                messageElement.className = `message ${isMyMessage ? 'my-message' : 'friend-message'}`
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                    ${isMyMessage ? '' : `<div class="message-sender">${message.sender}</div>`}
                `
                messagesList.appendChild(messageElement)
            })
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesList.scrollTop = messagesList.scrollHeight
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp)
            const now = new Date()
            const diff = now - date
            const minutes = Math.floor(diff / 60000)
            const hours = Math.floor(diff / 3600000)
            
            if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        }

        function sendMessage() {
            if (!currentChat) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!')
                return
            }
            
            const messageText = document.getElementById('messageText')
            const content = messageText.value.trim()
            
            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!')
                return
            }
            
            const newMessage = {
                id: Date.now(),
                sender: currentUser,
                receiver: currentChat,
                content: content,
                timestamp: new Date().toISOString()
            }
            
            messages.push(newMessage)
            localStorage.setItem('messages', JSON.stringify(messages))
            
            messageText.value = ''
            loadMessages(currentChat)
            loadChats() // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        }

        function addMessageEmoji(emoji) {
            const messageText = document.getElementById('messageText')
            messageText.value += emoji
            messageText.focus()
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage()
            }
        }

        function clearChat(friendUsername) {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏?')) return
            
            messages = messages.filter(m => 
                !((m.sender === currentUser && m.receiver === friendUsername) ||
                  (m.sender === friendUsername && m.receiver === currentUser))
            )
            
            localStorage.setItem('messages', JSON.stringify(messages))
            loadMessages(friendUsername)
            loadChats()
        }

        async function startNewChat() {
            const modal = document.getElementById('newChatModal')
            const friendsList = document.getElementById('friendsForChat')
            
            try {
                const userFriends = await friendsAPI.getFriends(currentUser)
                
                friendsList.innerHTML = ''
                
                if (userFriends.length === 0) {
                    friendsList.innerHTML = '<div class="no-friends">üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>'
                } else {
                    userFriends.forEach(friendship => {
                        const friendUsername = friendship.user1 === currentUser ? friendship.user2 : friendship.user1
                        const friendElement = document.createElement('div')
                        friendElement.className = 'friend-for-chat'
                        friendElement.onclick = () => {
                            openChat(friendUsername)
                            closeNewChatModal()
                        }
                        friendElement.innerHTML = `
                            <img src="https://ui-avatars.com/api/?name=${friendUsername}&background=667eea&color=fff" class="avatar">
                            <strong>${friendUsername}</strong>
                            <span class="chat-action">üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç</span>
                        `
                        friendsList.appendChild(friendElement)
                    })
                }
                
                modal.style.display = 'block'
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error)
                friendsList.innerHTML = '<div class="no-friends">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π</div>'
            }
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').style.display = 'none'
        }

        function logout() {
            localStorage.removeItem('currentUser')
            window.location.href = 'login.html'
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('newChatModal')
            if (event.target == modal) {
                closeNewChatModal()
            }
        }

        async function init() {
            checkAuth()
        }

        init()
    </script>
</body>
</html>

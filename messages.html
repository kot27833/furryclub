<!DOCTYPE html>
<html>
<head>
    <title>–°–æ–æ–±—â–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h1>
        <div>
            <a href="index.html" class="btn">–õ–µ–Ω—Ç–∞</a>
            <a href="friends.html" class="btn">–î—Ä—É–∑—å—è</a>
            <button onclick="logout()" class="btn">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <h3 id="chatWith">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h3>
            </div>
            
            <div class="friends-sidebar">
                <h4>–í–∞—à–∏ –¥—Ä—É–∑—å—è</h4>
                <div id="friendsChatList"></div>
            </div>
            
            <div class="messages-area">
                <div id="messagesList" class="messages-list"></div>
                
                <div class="message-input">
                    <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChatWith = null;

        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            currentChatWith = localStorage.getItem('chatWith');
            if (currentChatWith) {
                loadChat(currentChatWith);
            }
            
            loadFriendsList();
        }

        function getMessages() {
            const messages = localStorage.getItem('messages');
            return messages ? JSON.parse(messages) : {};
        }

        function saveMessages(messages) {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function getFriends() {
            const friends = localStorage.getItem('friends');
            return friends ? JSON.parse(friends) : {};
        }

        function loadFriendsList() {
            const friendsList = document.getElementById('friendsChatList');
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            friendsList.innerHTML = '';
            
            const myFriends = friendsData[currentUser] || [];
            
            if (myFriends.length === 0) {
                friendsList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</p>';
                return;
            }
            
            myFriends.forEach(friend => {
                const friendElement = document.createElement('div');
                friendElement.className = `friend-chat-item ${friend === currentChatWith ? 'active' : ''}`;
                friendElement.innerHTML = `
                    <div class="friend-avatar">üë§</div>
                    <div class="friend-name">${friend}</div>
                `;
                friendElement.onclick = () => loadChat(friend);
                friendsList.appendChild(friendElement);
            });
        }

        function loadChat(friendUsername) {
            currentChatWith = friendUsername;
            localStorage.setItem('chatWith', friendUsername);
            document.getElementById('chatWith').textContent = `–ß–∞—Ç —Å ${friendUsername}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ –¥—Ä—É–∑–µ–π
            document.querySelectorAll('.friend-chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.friend-chat-item').forEach(item => {
                if (item.querySelector('.friend-name').textContent === friendUsername) {
                    item.classList.add('active');
                }
            });
            
            const messages = getMessages();
            const currentUser = localStorage.getItem('currentUser');
            const chatId = [currentUser, friendUsername].sort().join('_');
            
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            if (!messages[chatId] || messages[chatId].length === 0) {
                messagesList.innerHTML = '<p class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>';
                return;
            }
            
            messages[chatId].forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.sender === currentUser ? 'my-message' : 'friend-message'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${msg.text}</div>
                    <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                `;
                messagesList.appendChild(messageElement);
            });
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function sendMessage() {
            if (!currentChatWith) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }
            
            const messageText = document.getElementById('messageText');
            const text = messageText.value.trim();
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            const messages = getMessages();
            const currentUser = localStorage.getItem('currentUser');
            const chatId = [currentUser, currentChatWith].sort().join('_');
            
            if (!messages[chatId]) messages[chatId] = [];
            
            messages[chatId].push({
                sender: currentUser,
                text: text,
                timestamp: new Date().toISOString()
            });
            
            saveMessages(messages);
            messageText.value = '';
            loadChat(currentChatWith);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('chatWith');
            window.location.href = 'login.html';
        }

        checkAuth();
    </script>
</body>
</html>
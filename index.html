<!DOCTYPE html>
<html>
<head>
    <title>MySocialNet - –ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üê¨ MySocialNet</h1>
        <nav>
            <a href="index.html" class="nav-btn active">üè† –õ–µ–Ω—Ç–∞</a>
            <a href="profile.html" class="nav-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="friends.html" class="nav-btn">üë• –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-btn">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <span id="userWelcome"></span>
            <button onclick="logout()" class="btn logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </nav>
    </header>

    <div class="container">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="postsCount">0</div>
                <div class="stat-label">–ü–æ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usersCount">0</div>
                <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineCount">1</div>
                <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ -->
        <div class="create-post">
            <div class="post-header">
                <img src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff" class="avatar" id="userAvatar">
                <textarea id="postText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
            </div>
            <div class="post-actions">
                <button onclick="createPost()" class="btn post-btn">üìù –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button onclick="addEmoji('üòä')" class="emoji-btn">üòä</button>
                <button onclick="addEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
                <button onclick="addEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                <button onclick="addEmoji('üî•')" class="emoji-btn">üî•</button>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterPosts('all')">–í—Å–µ –ø–æ—Å—Ç—ã</button>
            <button class="filter-btn" onclick="filterPosts('popular')">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
        </div>
        
        <!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
        <div id="postsContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeComments()">&times;</span>
            <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div id="commentsList" class="comments-list"></div>
            <div class="add-comment">
                <input type="text" id="commentText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onkeypress="handleCommentKeyPress(event)">
                <button onclick="addComment()" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { postsAPI, likesAPI, commentsAPI, authAPI } from './supabase.js'

        let currentUser = null
        let currentPostId = null

        function checkAuth() {
            currentUser = localStorage.getItem('currentUser')
            if (!currentUser) {
                window.location.href = 'login.html'
                return
            }
            document.getElementById('userWelcome').textContent = currentUser
        }

        async function updateStats() {
            try {
                const posts = await postsAPI.getPosts()
                const users = await authAPI.getAllUsers()
                
                document.getElementById('postsCount').textContent = posts.length
                document.getElementById('usersCount').textContent = users.length
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error)
            }
        }

        async function loadPosts(filter = 'all') {
            const postsContainer = document.getElementById('postsContainer')
            if (!postsContainer) return
            
            postsContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>'
            
            try {
                let posts = await postsAPI.getPosts()
                
                if (filter === 'popular') {
                    posts = posts.sort((a, b) => b.likes_count - a.likes_count)
                }
                
                if (posts.length === 0) {
                    postsContainer.innerHTML = '<div class="no-posts">üò¥ –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>'
                    return
                }
                
                postsContainer.innerHTML = ''
                
                for (const post of posts) {
                    const likes = await likesAPI.getPostLikes(post.id)
                    const hasLiked = await likesAPI.hasLiked(post.id, currentUser)
                    const postComments = await commentsAPI.getComments(post.id)
                    const isMyPost = post.author === currentUser
                    
                    const postElement = document.createElement('div')
                    postElement.className = 'post'
                    postElement.innerHTML = `
                        <div class="post-header">
                            <div class="user-info">
                                <img src="https://ui-avatars.com/api/?name=${post.author}&background=667eea&color=fff" class="avatar">
                                <div>
                                    <strong>${post.author}</strong>
                                    <div class="post-time">${timeAgo(new Date(post.created_at))}</div>
                                </div>
                            </div>
                            ${isMyPost ? `<button onclick="deletePost(${post.id})" class="delete-btn">üóëÔ∏è</button>` : ''}
                        </div>
                        <div class="post-content">${formatPostContent(post.content)}</div>
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${likes.length}</span>
                            <span>üí¨ ${postComments.length}</span>
                        </div>
                        <div class="post-actions">
                            <button onclick="likePost(${post.id})" class="action-btn ${hasLiked ? 'liked' : ''}">
                                ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} –õ–∞–π–∫
                            </button>
                            <button onclick="openComments(${post.id})" class="action-btn">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    `
                    postsContainer.appendChild(postElement)
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error)
                postsContainer.innerHTML = '<div class="no-posts">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</div>'
            }
        }

        function filterPosts(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'))
            event.target.classList.add('active')
            loadPosts(type)
        }

        function formatPostContent(content) {
            return content
                .replace(/:\)/g, 'üòä')
                .replace(/:\(/g, 'üò¢')
                .replace(/<3/g, '‚ù§Ô∏è')
                .replace(/!!!/g, '‚ùóÔ∏è')
                .replace(/\n/g, '<br>')
        }

        function timeAgo(date) {
            const now = new Date()
            const diff = now - date
            const minutes = Math.floor(diff / 60000)
            const hours = Math.floor(diff / 3600000)
            const days = Math.floor(diff / 86400000)
            
            if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`
            if (days < 7) return `${days} –¥ –Ω–∞–∑–∞–¥`
            return date.toLocaleDateString()
        }

        function addEmoji(emoji) {
            const textarea = document.getElementById('postText')
            textarea.value += emoji
            textarea.focus()
        }

        async function createPost() {
            const postText = document.getElementById('postText')
            const content = postText.value.trim()
            
            if (!content) {
                alert('–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!')
                return
            }
            
            try {
                await postsAPI.createPost(content, currentUser)
                postText.value = ''
                loadPosts()
                updateStats()
                alert('‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!')
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message)
            }
        }

        async function likePost(postId) {
            try {
                const hasLiked = await likesAPI.hasLiked(postId, currentUser)
                
                if (hasLiked) {
                    await likesAPI.unlikePost(postId, currentUser)
                } else {
                    await likesAPI.likePost(postId, currentUser)
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
                const likes = await likesAPI.getPostLikes(postId)
                await postsAPI.updateLikes(postId, likes.length)
                
                loadPosts()
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ª–∞–π–∫–∞: ' + error.message)
            }
        }

        async function deletePost(postId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return
            
            try {
                await postsAPI.deletePost(postId, currentUser)
                loadPosts()
                updateStats()
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message)
            }
        }

        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        async function openComments(postId) {
            currentPostId = postId
            document.getElementById('commentsModal').style.display = 'block'
            await loadComments(postId)
        }

        function closeComments() {
            document.getElementById('commentsModal').style.display = 'none'
            currentPostId = null
        }

        async function loadComments(postId) {
            const commentsList = document.getElementById('commentsList')
            
            try {
                const comments = await commentsAPI.getComments(postId)
                
                commentsList.innerHTML = ''
                
                if (comments.length === 0) {
                    commentsList.innerHTML = '<div class="no-comments">üí¨ –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>'
                    return
                }
                
                comments.forEach(comment => {
                    const commentElement = document.createElement('div')
                    commentElement.className = 'comment'
                    commentElement.innerHTML = `
                        <div class="comment-header">
                            <img src="https://ui-avatars.com/api/?name=${comment.author}&background=764ba2&color=fff" class="avatar-small">
                            <strong>${comment.author}</strong>
                            <span class="comment-time">${timeAgo(new Date(comment.created_at))}</span>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                    `
                    commentsList.appendChild(commentElement)
                })
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error)
                commentsList.innerHTML = '<div class="no-comments">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>'
            }
        }

        async function addComment() {
            if (!currentPostId) return
            
            const commentText = document.getElementById('commentText')
            const content = commentText.value.trim()
            
            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!')
                return
            }
            
            try {
                await commentsAPI.addComment(currentPostId, content, currentUser)
                commentText.value = ''
                await loadComments(currentPostId)
                loadPosts() // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message)
            }
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter') {
                addComment()
            }
        }

        function logout() {
            localStorage.removeItem('currentUser')
            window.location.href = 'login.html'
        }

        // –ó–∞–ø—É—Å–∫
        async function init() {
            checkAuth()
            await updateStats()
            await loadPosts()
        }

        init()
    </script>
</body>
</html>

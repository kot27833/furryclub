<!DOCTYPE html>
<html>
<head>
    <title>MySocialNet - –ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üê¨ MySocialNet</h1>
        <nav>
            <a href="index.html" class="nav-btn active">üè† –õ–µ–Ω—Ç–∞</a>
            <a href="profile.html" class="nav-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="friends.html" class="nav-btn">üë• –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-btn">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <span id="userWelcome"></span>
            <button onclick="logout()" class="btn logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </nav>
    </header>

    <div class="container">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="postsCount">0</div>
                <div class="stat-label">–ü–æ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usersCount">0</div>
                <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineCount">1</div>
                <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ -->
        <div class="create-post">
            <div class="post-header">
                <img src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff" class="avatar" id="userAvatar">
                <textarea id="postText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
            </div>
            <div class="post-actions">
                <button onclick="createPost()" class="btn post-btn">üìù –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button onclick="addEmoji('üòä')" class="emoji-btn">üòä</button>
                <button onclick="addEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
                <button onclick="addEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                <button onclick="addEmoji('üî•')" class="emoji-btn">üî•</button>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterPosts('all')">–í—Å–µ –ø–æ—Å—Ç—ã</button>
            <button class="filter-btn" onclick="filterPosts('popular')">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
            <button class="filter-btn" onclick="filterPosts('friends')">–î—Ä—É–∑—å—è</button>
        </div>
        
        <!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
        <div id="postsContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeComments()">&times;</span>
            <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div id="commentsList" class="comments-list"></div>
            <div class="add-comment">
                <input type="text" id="commentText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onkeypress="handleCommentKeyPress(event)">
                <button onclick="addComment()" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
        function getLocalDB() {
            const db = localStorage.getItem('social_network_db');
            return db ? JSON.parse(db) : { users: [], posts: [], comments: [], friends: [], messages: [] };
        }

        function saveLocalDB(db) {
            localStorage.setItem('social_network_db', JSON.stringify(db));
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub
        async function syncWithGitHub() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/–í–ê–®_–ù–ò–ö/my-social-network/main/database.json?t=' + Date.now());
                const githubDB = await response.json();
                const localDB = getLocalDB();
                
                const mergedDB = {
                    users: [...new Map([...localDB.users, ...githubDB.users].map(user => [user.username, user])).values()],
                    posts: [...new Map([...localDB.posts, ...githubDB.posts].map(post => [post.id, post])).values()],
                    comments: [...new Map([...localDB.comments, ...githubDB.comments].map(comment => [comment.id, comment])).values()],
                    friends: [...new Map([...localDB.friends, ...githubDB.friends].map(friend => [friend.id, friend])).values()],
                    messages: [...new Map([...localDB.messages, ...githubDB.messages].map(msg => [msg.id, msg])).values()]
                };
                
                saveLocalDB(mergedDB);
                return mergedDB;
            } catch (error) {
                return getLocalDB();
            }
        }

        let currentUser = null;
        let database = { users: [], posts: [], comments: [], friends: [], messages: [] };
        let currentPostId = null;

        async function loadDatabase() {
            database = await syncWithGitHub();
            updateStats();
        }

        function checkAuth() {
            currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('userWelcome').textContent = currentUser;
        }

        function updateStats() {
            document.getElementById('postsCount').textContent = database.posts.length;
            document.getElementById('usersCount').textContent = database.users.length;
        }

        function loadPosts(filter = 'all') {
            const postsContainer = document.getElementById('postsContainer');
            if (!postsContainer) return;
            
            postsContainer.innerHTML = '';
            
            let postsToShow = [...database.posts];
            
            if (filter === 'popular') {
                postsToShow = postsToShow.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0));
            } else if (filter === 'friends') {
                const userFriends = database.friends.filter(f => f.user1 === currentUser || f.user2 === currentUser);
                const friendUsernames = userFriends.map(f => f.user1 === currentUser ? f.user2 : f.user1);
                postsToShow = postsToShow.filter(post => friendUsernames.includes(post.author));
            }
            
            postsToShow = postsToShow.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (postsToShow.length === 0) {
                postsContainer.innerHTML = '<div class="no-posts">üò¥ –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }
            
            postsToShow.forEach(post => {
                const hasLiked = post.likes && post.likes.includes(currentUser);
                const postComments = database.comments.filter(c => c.postId === post.id);
                const isMyPost = post.author === currentUser;
                
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="user-info">
                            <img src="https://ui-avatars.com/api/?name=${post.author}&background=667eea&color=fff" class="avatar">
                            <div>
                                <strong>${post.author}</strong>
                                <div class="post-time">${timeAgo(new Date(post.timestamp))}</div>
                            </div>
                        </div>
                        ${isMyPost ? `<button onclick="deletePost(${post.id})" class="delete-btn">üóëÔ∏è</button>` : ''}
                    </div>
                    <div class="post-content">${formatPostContent(post.content)}</div>
                    <div class="post-stats">
                        <span>‚ù§Ô∏è ${post.likes ? post.likes.length : 0}</span>
                        <span>üí¨ ${postComments.length}</span>
                        <span>üëÅÔ∏è ${post.views || 0}</span>
                    </div>
                    <div class="post-actions">
                        <button onclick="likePost(${post.id})" class="action-btn ${hasLiked ? 'liked' : ''}">
                            ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} –õ–∞–π–∫
                        </button>
                        <button onclick="openComments(${post.id})" class="action-btn">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="sharePost(${post.id})" class="action-btn">üîÑ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                    </div>
                `;
                
                postsContainer.appendChild(postElement);
            });
        }

        function filterPosts(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadPosts(type);
        }

        function formatPostContent(content) {
            // –ü—Ä–æ—Å—Ç—ã–µ —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            return content
                .replace(/:\)/g, 'üòä')
                .replace(/:\(/g, 'üò¢')
                .replace(/<3/g, '‚ù§Ô∏è')
                .replace(/!!!/g, '‚ùóÔ∏è')
                .replace(/\n/g, '<br>');
        }

        function timeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
            if (days < 7) return `${days} –¥ –Ω–∞–∑–∞–¥`;
            return date.toLocaleDateString();
        }

        function addEmoji(emoji) {
            const textarea = document.getElementById('postText');
            textarea.value += emoji;
            textarea.focus();
        }

        async function createPost() {
            const postText = document.getElementById('postText');
            const content = postText.value.trim();
            
            if (!content) {
                alert('–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!');
                return;
            }
            
            const newPost = {
                id: Date.now(),
                author: currentUser,
                content: content,
                timestamp: new Date().toISOString(),
                likes: [],
                views: 0
            };
            
            database.posts.unshift(newPost);
            saveLocalDB(database);
            postText.value = '';
            loadPosts();
            
            alert('‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
        }

        function likePost(postId) {
            const post = database.posts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.likes) post.likes = [];
            
            const userIndex = post.likes.indexOf(currentUser);
            
            if (userIndex === -1) {
                post.likes.push(currentUser);
            } else {
                post.likes.splice(userIndex, 1);
            }
            
            saveLocalDB(database);
            loadPosts();
        }

        function deletePost(postId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
            
            database.posts = database.posts.filter(p => p.id !== postId);
            database.comments = database.comments.filter(c => c.postId !== postId);
            saveLocalDB(database);
            loadPosts();
        }

        function sharePost(postId) {
            alert('üì§ –§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
        }

        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        function openComments(postId) {
            currentPostId = postId;
            document.getElementById('commentsModal').style.display = 'block';
            loadComments(postId);
        }

        function closeComments() {
            document.getElementById('commentsModal').style.display = 'none';
            currentPostId = null;
        }

        function loadComments(postId) {
            const commentsList = document.getElementById('commentsList');
            const postComments = database.comments.filter(c => c.postId === postId)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            commentsList.innerHTML = '';
            
            if (postComments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">üí¨ –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }
            
            postComments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <img src="https://ui-avatars.com/api/?name=${comment.author}&background=764ba2&color=fff" class="avatar-small">
                        <strong>${comment.author}</strong>
                        <span class="comment-time">${timeAgo(new Date(comment.timestamp))}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        function addComment() {
            if (!currentPostId) return;
            
            const commentText = document.getElementById('commentText');
            const content = commentText.value.trim();
            
            if (!content) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!');
                return;
            }
            
            const newComment = {
                id: Date.now(),
                postId: currentPostId,
                author: currentUser,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            if (!database.comments) database.comments = [];
            database.comments.push(newComment);
            saveLocalDB(database);
            
            commentText.value = '';
            loadComments(currentPostId);
            loadPosts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter') {
                addComment();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // –ó–∞–ø—É—Å–∫
        async function init() {
            await loadDatabase();
            checkAuth();
            loadPosts();
        }

        init();
    </script>
</body>
</html>
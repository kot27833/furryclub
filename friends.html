<!DOCTYPE html>
<html>
<head>
    <title>–î—Ä—É–∑—å—è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üë• –î—Ä—É–∑—å—è</h1>
        <div>
            <a href="index.html" class="btn">–õ–µ–Ω—Ç–∞</a>
            <button onclick="logout()" class="btn">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="container">
        <div class="search-section">
            <input type="text" id="searchUser" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            <button onclick="searchUsers()" class="btn">–ü–æ–∏—Å–∫</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('friends')">–ú–æ–∏ –¥—Ä—É–∑—å—è</button>
            <button class="tab-btn" onclick="openTab('requests')">–ó–∞–ø—Ä–æ—Å—ã</button>
            <button class="tab-btn" onclick="openTab('find')">–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</button>
        </div>
        
        <div id="friends" class="tab-content active">
            <h3>–ú–æ–∏ –¥—Ä—É–∑—å—è</h3>
            <div id="friendsList"></div>
        </div>
        
        <div id="requests" class="tab-content">
            <h3>–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è</h3>
            <div id="requestsList"></div>
        </div>
        
        <div id="find" class="tab-content">
            <h3>–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</h3>
            <div id="searchResults"></div>
        </div>
    </div>

    <script>
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
        }

        function getUsers() {
            const users = localStorage.getItem('users');
            return users ? JSON.parse(users) : {};
        }

        function getFriends() {
            const friends = localStorage.getItem('friends');
            return friends ? JSON.parse(friends) : {};
        }

        function saveFriends(friends) {
            localStorage.setItem('friends', JSON.stringify(friends));
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'friends') loadFriends();
            if (tabName === 'requests') loadRequests();
            if (tabName === 'find') loadAllUsers();
        }

        function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            const users = getUsers();
            
            friendsList.innerHTML = '';
            
            const myFriends = friendsData[currentUser] || [];
            
            if (myFriends.length === 0) {
                friendsList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</p>';
                return;
            }
            
            myFriends.forEach(friendUsername => {
                const friendElement = document.createElement('div');
                friendElement.className = 'friend-item';
                friendElement.innerHTML = `
                    <div class="friend-info">
                        <strong>üë§ ${friendUsername}</strong>
                        <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date(users[friendUsername].joined).toLocaleDateString()}</span>
                    </div>
                    <div class="friend-actions">
                        <button onclick="sendMessage('${friendUsername}')" class="btn-small">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
                        <button onclick="removeFriend('${friendUsername}')" class="btn-small btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                friendsList.appendChild(friendElement);
            });
        }

        function loadRequests() {
            const requestsList = document.getElementById('requestsList');
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            requestsList.innerHTML = '';
            
            const myRequests = friendsData.requests?.[currentUser] || [];
            
            if (myRequests.length === 0) {
                requestsList.innerHTML = '<p>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</p>';
                return;
            }
            
            myRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'friend-item';
                requestElement.innerHTML = `
                    <div class="friend-info">
                        <strong>üë§ ${request.from}</strong>
                        <span>–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</span>
                    </div>
                    <div class="friend-actions">
                        <button onclick="acceptRequest('${request.from}')" class="btn-small">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                        <button onclick="declineRequest('${request.from}')" class="btn-small btn-danger">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                `;
                requestsList.appendChild(requestElement);
            });
        }

        function loadAllUsers() {
            const searchResults = document.getElementById('searchResults');
            const users = getUsers();
            const currentUser = localStorage.getItem('currentUser');
            const friendsData = getFriends();
            const myFriends = friendsData[currentUser] || [];
            
            searchResults.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                if (username !== currentUser && !myFriends.includes(username)) {
                    const userElement = document.createElement('div');
                    userElement.className = 'friend-item';
                    userElement.innerHTML = `
                        <div class="friend-info">
                            <strong>üë§ ${username}</strong>
                            <span>–ù–∞ —Å–∞–π—Ç–µ —Å: ${new Date(users[username].joined).toLocaleDateString()}</span>
                        </div>
                        <button onclick="sendFriendRequest('${username}')" class="btn-small">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
                    `;
                    searchResults.appendChild(userElement);
                }
            });
        }

        function sendFriendRequest(toUsername) {
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            if (!friendsData.requests) friendsData.requests = {};
            if (!friendsData.requests[toUsername]) friendsData.requests[toUsername] = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å
            const existingRequest = friendsData.requests[toUsername].find(req => req.from === currentUser);
            if (existingRequest) {
                alert('–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                return;
            }
            
            friendsData.requests[toUsername].push({
                from: currentUser,
                timestamp: new Date().toISOString()
            });
            
            saveFriends(friendsData);
            alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        }

        function acceptRequest(fromUsername) {
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥—Ä—É–∑—å—è
            if (!friendsData[currentUser]) friendsData[currentUser] = [];
            if (!friendsData[fromUsername]) friendsData[fromUsername] = [];
            
            friendsData[currentUser].push(fromUsername);
            friendsData[fromUsername].push(currentUser);
            
            // –£–¥–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            friendsData.requests[currentUser] = friendsData.requests[currentUser].filter(
                req => req.from !== fromUsername
            );
            
            saveFriends(friendsData);
            loadRequests();
            alert(`${fromUsername} —Ç–µ–ø–µ—Ä—å –≤–∞—à –¥—Ä—É–≥!`);
        }

        function declineRequest(fromUsername) {
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            friendsData.requests[currentUser] = friendsData.requests[currentUser].filter(
                req => req.from !== fromUsername
            );
            
            saveFriends(friendsData);
            loadRequests();
        }

        function removeFriend(friendUsername) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${friendUsername} –∏–∑ –¥—Ä—É–∑–µ–π?`)) return;
            
            const friendsData = getFriends();
            const currentUser = localStorage.getItem('currentUser');
            
            friendsData[currentUser] = friendsData[currentUser].filter(f => f !== friendUsername);
            friendsData[friendUsername] = friendsData[friendUsername].filter(f => f !== currentUser);
            
            saveFriends(friendsData);
            loadFriends();
        }

        function sendMessage(friendUsername) {
            localStorage.setItem('chatWith', friendUsername);
            window.location.href = 'messages.html';
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const users = getUsers();
            const currentUser = localStorage.getItem('currentUser');
            const friendsData = getFriends();
            const myFriends = friendsData[currentUser] || [];
            const searchResults = document.getElementById('searchResults');
            
            searchResults.innerHTML = '';
            
            const filteredUsers = Object.keys(users).filter(username => 
                username !== currentUser && 
                !myFriends.includes(username) &&
                username.toLowerCase().includes(searchTerm)
            );
            
            if (filteredUsers.length === 0) {
                searchResults.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            filteredUsers.forEach(username => {
                const userElement = document.createElement('div');
                userElement.className = 'friend-item';
                userElement.innerHTML = `
                    <div class="friend-info">
                        <strong>üë§ ${username}</strong>
                        <span>–ù–∞ —Å–∞–π—Ç–µ —Å: ${new Date(users[username].joined).toLocaleDateString()}</span>
                    </div>
                    <button onclick="sendFriendRequest('${username}')" class="btn-small">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
                `;
                searchResults.appendChild(userElement);
            });
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        checkAuth();
        loadFriends();
    </script>
</body>
</html>
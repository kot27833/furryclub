<!DOCTYPE html>
<html>
<head>
    <title>–î—Ä—É–∑—å—è - MySocialNet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üê¨ MySocialNet</h1>
        <nav>
            <a href="index.html" class="nav-btn">üè† –õ–µ–Ω—Ç–∞</a>
            <a href="profile.html" class="nav-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="friends.html" class="nav-btn active">üë• –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-btn">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <span id="userWelcome"></span>
            <button onclick="logout()" class="btn logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </nav>
    </header>

    <div class="container">
        <div class="friends-header">
            <h2>üë• –ú–æ–∏ –¥—Ä—É–∑—å—è</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π..." onkeyup="searchUsers()">
            </div>
        </div>

        <div class="friends-tabs">
            <button class="tab-btn active" onclick="openFriendsTab('all')">–í—Å–µ –¥—Ä—É–∑—å—è</button>
            <button class="tab-btn" onclick="openFriendsTab('find')">–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</button>
        </div>

        <div id="all-friends" class="tab-content active">
            <h3>–ú–æ–∏ –¥—Ä—É–∑—å—è</h3>
            <div id="friendsList" class="friends-grid"></div>
        </div>

        <div id="find-friends" class="tab-content">
            <h3>–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</h3>
            <div id="findFriendsList" class="friends-grid"></div>
        </div>
    </div>

    <script type="module">
        import { friendsAPI, authAPI } from './supabase.js'

        let currentUser = null
        let allUsers = []

        function checkAuth() {
            currentUser = localStorage.getItem('currentUser')
            if (!currentUser) {
                window.location.href = 'login.html'
                return
            }
            document.getElementById('userWelcome').textContent = currentUser
            loadFriends()
        }

        function openFriendsTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'))
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'))
            
            document.getElementById(tabName + '-friends').classList.add('active')
            event.target.classList.add('active')
            
            if (tabName === 'find') {
                loadFindFriends()
            }
        }

        async function loadFriends() {
            await loadAllFriends()
        }

        async function loadAllFriends() {
            const container = document.getElementById('friendsList')
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π...</div>'
            
            try {
                const userFriends = await friendsAPI.getFriends(currentUser)
                
                container.innerHTML = ''
                
                if (userFriends.length === 0) {
                    container.innerHTML = '<div class="no-friends">üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>'
                    return
                }
                
                userFriends.forEach(friendship => {
                    const friendUsername = friendship.user1 === currentUser ? friendship.user2 : friendship.user1
                    
                    const friendElement = document.createElement('div')
                    friendElement.className = 'friend-card'
                    friendElement.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${friendUsername}&background=667eea&color=fff" class="avatar">
                        <div class="friend-info">
                            <strong>${friendUsername}</strong>
                            <span class="friend-status online">üü¢ –í —Å–µ—Ç–∏</span>
                            <span class="friend-date">–î—Ä—É–∑—å—è —Å ${new Date(friendship.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="friend-actions">
                            <button onclick="sendMessageToFriend('${friendUsername}')" class="btn btn-small">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
                            <button onclick="removeFriend('${friendUsername}')" class="btn btn-small btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `
                    container.appendChild(friendElement)
                })
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error)
                container.innerHTML = '<div class="no-friends">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π</div>'
            }
        }

        async function loadFindFriends() {
            const container = document.getElementById('findFriendsList')
            container.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>'
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏—Ö –¥—Ä—É–∑–µ–π
                const currentFriends = await friendsAPI.getFriends(currentUser)
                const friendUsernames = currentFriends.map(f => 
                    f.user1 === currentUser ? f.user2 : f.user1
                )
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const users = await authAPI.getAllUsers()
                allUsers = users
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º - —É–±–∏—Ä–∞–µ–º —Å–µ–±—è –∏ —Ç–µ–∫—É—â–∏—Ö –¥—Ä—É–∑–µ–π
                const availableUsers = users.filter(u => 
                    u.username !== currentUser && !friendUsernames.includes(u.username)
                )
                
                container.innerHTML = ''
                
                if (availableUsers.length === 0) {
                    container.innerHTML = '<div class="no-friends">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –≤–∞—à–∏ –¥—Ä—É–∑—å—è!</div>'
                    return
                }
                
                availableUsers.forEach(user => {
                    const userElement = document.createElement('div')
                    userElement.className = 'friend-card'
                    userElement.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${user.username}&background=667eea&color=fff" class="avatar">
                        <div class="friend-info">
                            <strong>${user.username}</strong>
                            <span class="friend-date">–ù–∞ —Å–∞–π—Ç–µ —Å ${new Date(user.created_at).toLocaleDateString()}</span>
                        </div>
                        <button onclick="addFriend('${user.username}')" class="btn btn-small">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
                    `
                    container.appendChild(userElement)
                })
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π:', error)
                container.innerHTML = '<div class="no-friends">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π</div>'
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase()
            const cards = document.querySelectorAll('.friend-card')
            
            cards.forEach(card => {
                const username = card.querySelector('strong').textContent.toLowerCase()
                if (username.includes(searchTerm)) {
                    card.style.display = 'flex'
                } else {
                    card.style.display = 'none'
                }
            })
        }

        async function addFriend(friendUsername) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –¥—Ä—É–∂–±—ã
                const existingFriends = await friendsAPI.getFriends(currentUser)
                const existingFriendship = existingFriends.find(f => 
                    (f.user1 === currentUser && f.user2 === friendUsername) ||
                    (f.user1 === friendUsername && f.user2 === currentUser)
                )
                
                if (existingFriendship) {
                    alert('‚ùå –í—ã —É–∂–µ –¥—Ä—É–∑—å—è —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!')
                    return
                }
                
                // –°–æ–∑–¥–∞–µ–º –¥—Ä—É–∂–±—É
                await friendsAPI.addFriend(currentUser, friendUsername)
                
                alert(`‚úÖ –¢–µ–ø–µ—Ä—å –≤—ã –¥—Ä—É–∑—å—è —Å ${friendUsername}!`)
                loadFindFriends()
                loadAllFriends()
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞: ' + error.message)
            }
        }

        async function removeFriend(friendUsername) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${friendUsername} –∏–∑ –¥—Ä—É–∑–µ–π?`)) return
            
            try {
                await friendsAPI.removeFriend(currentUser, friendUsername)
                alert(`üëã ${friendUsername} —É–¥–∞–ª–µ–Ω –∏–∑ –¥—Ä—É–∑–µ–π`)
                loadAllFriends()
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞: ' + error.message)
            }
        }

        function sendMessageToFriend(friendUsername) {
            alert(`üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å ${friendUsername} (—Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)`)
        }

        function logout() {
            localStorage.removeItem('currentUser')
            window.location.href = 'login.html'
        }

        async function init() {
            checkAuth()
        }

        init()
    </script>
</body>
</html>

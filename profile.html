<!DOCTYPE html>
<html>
<head>
    <title>–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å - MySocialNet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üê¨ MySocialNet</h1>
        <nav>
            <a href="index.html" class="nav-btn">üè† –õ–µ–Ω—Ç–∞</a>
            <a href="profile.html" class="nav-btn active">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="friends.html" class="nav-btn">üë• –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-btn">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <span id="userWelcome"></span>
            <button onclick="logout()" class="btn logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </nav>
    </header>

    <div class="container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff&size=120" id="profileAvatar">
                <button onclick="changeAvatar()" class="btn btn-small">üñºÔ∏è –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
            </div>
            <div class="profile-info">
                <h2 id="profileUsername"></h2>
                <div class="profile-stats">
                    <div class="stat">
                        <strong id="userPostsCount">0</strong>
                        <span>–ø–æ—Å—Ç–æ–≤</span>
                    </div>
                    <div class="stat">
                        <strong id="userFriendsCount">0</strong>
                        <span>–¥—Ä—É–∑–µ–π</span>
                    </div>
                    <div class="stat">
                        <strong id="userLikesCount">0</strong>
                        <span>–ª–∞–π–∫–æ–≤</span>
                    </div>
                </div>
                <p class="join-date">–ù–∞ —Å–∞–π—Ç–µ —Å <span id="joinDate"></span></p>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="tab-btn active" onclick="openTab('my-posts')">üìù –ú–æ–∏ –ø–æ—Å—Ç—ã</button>
            <button class="tab-btn" onclick="openTab('liked-posts')">‚ù§Ô∏è –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</button>
        </div>

        <div id="my-posts" class="tab-content active">
            <h3>–ú–æ–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>
            <div id="myPostsContainer"></div>
        </div>

        <div id="liked-posts" class="tab-content">
            <h3>–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –ø–æ—Å—Ç—ã</h3>
            <div id="likedPostsContainer"></div>
        </div>
    </div>

    <script type="module">
        import { getPosts, getPostLikes, getComments, getFriends, getAllUsers, deletePost, hasLiked } from './supabase.js'

        let currentUser = null

        function checkAuth() {
            currentUser = localStorage.getItem('currentUser')
            if (!currentUser) {
                window.location.href = 'login.html'
                return
            }
            document.getElementById('userWelcome').textContent = currentUser
            document.getElementById('profileUsername').textContent = currentUser
            loadProfileData()
        }

        async function loadProfileData() {
            try {
                const users = await getAllUsers()
                const user = users.find(u => u.username === currentUser)
                const posts = await getPosts()
                const userPosts = posts.filter(p => p.author === currentUser)
                const friends = await getFriends(currentUser)
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let totalLikes = 0
                for (const post of userPosts) {
                    const likes = await getPostLikes(post.id)
                    totalLikes += likes.length
                }
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('userPostsCount').textContent = userPosts.length
                document.getElementById('userFriendsCount').textContent = friends.length
                document.getElementById('userLikesCount').textContent = totalLikes
                
                // –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                if (user && user.created_at) {
                    document.getElementById('joinDate').textContent = new Date(user.created_at).toLocaleDateString()
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
                loadMyPosts()
                loadLikedPosts()
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error)
            }
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'))
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'))
            
            document.getElementById(tabName).classList.add('active')
            event.target.classList.add('active')
        }

        async function loadMyPosts() {
            const container = document.getElementById('myPostsContainer')
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>'
            
            try {
                const posts = await getPosts()
                const userPosts = posts.filter(p => p.author === currentUser)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                
                container.innerHTML = ''
                
                if (userPosts.length === 0) {
                    container.innerHTML = '<div class="no-posts">üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</div>'
                    return
                }
                
                for (const post of userPosts) {
                    const likes = await getPostLikes(post.id)
                    const comments = await getComments(post.id)
                    
                    const postElement = document.createElement('div')
                    postElement.className = 'post'
                    postElement.innerHTML = `
                        <div class="post-header">
                            <strong>${post.author}</strong>
                            <span>${new Date(post.created_at).toLocaleString()}</span>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${likes.length}</span>
                            <span>üí¨ ${comments.length}</span>
                        </div>
                        <button onclick="deleteMyPost(${post.id})" class="btn btn-small btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    `
                    container.appendChild(postElement)
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error)
                container.innerHTML = '<div class="no-posts">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</div>'
            }
        }

        async function loadLikedPosts() {
            const container = document.getElementById('likedPostsContainer')
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–∞–π–∫–æ–≤...</div>'
            
            try {
                const posts = await getPosts()
                const likedPosts = []
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ª–∞–π–∫–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                for (const post of posts) {
                    const hasLikedPost = await hasLiked(post.id, currentUser)
                    if (hasLikedPost) {
                        likedPosts.push(post)
                    }
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
                likedPosts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                
                container.innerHTML = ''
                
                if (likedPosts.length === 0) {
                    container.innerHTML = '<div class="no-posts">‚ù§Ô∏è –í—ã –µ—â–µ –Ω–µ –ª–∞–π–∫–∞–ª–∏ –ø–æ—Å—Ç—ã</div>'
                    return
                }
                
                for (const post of likedPosts) {
                    const likes = await getPostLikes(post.id)
                    const comments = await getComments(post.id)
                    
                    const postElement = document.createElement('div')
                    postElement.className = 'post'
                    postElement.innerHTML = `
                        <div class="post-header">
                            <strong>${post.author}</strong>
                            <span>${new Date(post.created_at).toLocaleString()}</span>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${likes.length}</span>
                            <span>üí¨ ${comments.length}</span>
                        </div>
                    `
                    container.appendChild(postElement)
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∞–π–∫–æ–≤:', error)
                container.innerHTML = '<div class="no-posts">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∞–π–∫–æ–≤</div>'
            }
        }

        function changeAvatar() {
            alert('üñºÔ∏è –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!')
        }

        async function deleteMyPost(postId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return
            
            try {
                await deletePost(postId, currentUser)
                loadMyPosts()
                loadProfileData() // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message)
            }
        }

        function logout() {
            localStorage.removeItem('currentUser')
            window.location.href = 'login.html'
        }

        async function init() {
            checkAuth()
        }

        init()
    </script>
</body>
</html>
